<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Publisher Pro</title>

  <!-- Fonts - Similar to Claude -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Söhne:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    /* =============================================
       AI PUBLISHER PRO - CLAUDE DESIGN SYSTEM
       Minimalist • Clean • Premium • Trust
       ============================================= */

    /* CSS Reset */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Design Tokens - Claude Inspired */
    :root {
      /* Colors - Cool, Neutral, Professional */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F9FAFB;
      --bg-tertiary: #F3F4F6;
      --bg-hover: #F0F1F3;

      /* Text */
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --text-tertiary: #9CA3AF;
      --text-inverse: #FFFFFF;

      /* Accent - Coral/Salmon like Claude */
      --accent-primary: #D97757;
      --accent-hover: #C96A4B;
      --accent-light: #FDF4F1;
      --accent-glow: rgba(217, 119, 87, 0.15);

      /* Borders */
      --border-light: #E5E7EB;
      --border-medium: #D1D5DB;
      --border-focus: var(--accent-primary);

      /* Shadows - Subtle */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.08);
      --shadow-focus: 0 0 0 3px var(--accent-glow);

      /* Typography */
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 2rem;

      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      --space-16: 4rem;
      --space-20: 5rem;

      /* Radius */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-2xl: 24px;
      --radius-full: 9999px;

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-normal: 200ms ease;
      --transition-slow: 300ms ease;

      /* Layout */
      --max-width: 680px;
      --header-height: 56px;
    }

    /* Base Styles */
    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* =============================================
       LAYOUT
       ============================================= */

    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header - Minimal like Claude */
    .header {
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-6);
      background: var(--bg-primary);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: 600;
      font-size: var(--font-size-lg);
      color: var(--text-primary);
      text-decoration: none;
    }


    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .header-btn {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
    }

    .header-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .header-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--space-16) var(--space-6);
    }

    /* =============================================
       HERO - Single Focus Point
       ============================================= */

    .hero {
      text-align: center;
      max-width: var(--max-width);
      margin-bottom: var(--space-12);
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--accent-light);
      color: var(--accent-primary);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: 500;
      margin-bottom: var(--space-6);
    }

    .hero-badge svg {
      width: 14px;
      height: 14px;
    }

    .hero-title {
      font-size: var(--font-size-3xl);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-4);
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .hero-subtitle {
      font-size: var(--font-size-lg);
      color: var(--text-secondary);
      max-width: 480px;
      margin: 0 auto;
    }

    /* =============================================
       UPLOAD ZONE - The Hero Element
       ============================================= */

    .upload-container {
      width: 100%;
      max-width: var(--max-width);
    }

    .upload-zone {
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-xl);
      padding: var(--space-16) var(--space-8);
      text-align: center;
      cursor: pointer;
      transition: var(--transition-normal);
      background: var(--bg-primary);
      position: relative;
      overflow: hidden;
    }

    .upload-zone::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--accent-light);
      opacity: 0;
      transition: var(--transition-normal);
    }

    .upload-zone:hover {
      border-color: var(--accent-primary);
    }

    .upload-zone:hover::before {
      opacity: 1;
    }

    .upload-zone.drag-over {
      border-color: var(--accent-primary);
    }

    .upload-zone.drag-over::before {
      opacity: 1;
    }

    .upload-content {
      position: relative;
      z-index: 1;
    }

    .upload-icon {
      width: 56px;
      height: 56px;
      margin: 0 auto var(--space-6);
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: var(--transition-normal);
    }

    .upload-zone:hover .upload-icon {
      background: var(--accent-primary);
      color: white;
      transform: scale(1.05);
    }

    .upload-icon svg {
      width: 24px;
      height: 24px;
    }

    .upload-text {
      font-size: var(--font-size-base);
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }

    .upload-text-link {
      color: var(--accent-primary);
      font-weight: 500;
    }

    .upload-hint {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
    }

    .upload-formats {
      display: flex;
      justify-content: center;
      gap: var(--space-2);
      margin-top: var(--space-6);
    }

    .format-tag {
      padding: var(--space-1) var(--space-3);
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Hidden file input */
    .upload-input {
      display: none;
    }

    /* =============================================
       OPTIONS - Progressive Disclosure
       ============================================= */

    .options-section {
      width: 100%;
      max-width: var(--max-width);
      margin-top: var(--space-8);
    }

    .options-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
      margin: 0 auto;
      border-radius: var(--radius-md);
    }

    .options-toggle:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .options-toggle svg {
      width: 16px;
      height: 16px;
      transition: var(--transition-normal);
    }

    .options-toggle.expanded svg {
      transform: rotate(180deg);
    }

    .options-panel {
      display: none;
      margin-top: var(--space-6);
      padding: var(--space-6);
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      animation: slideDown 0.3s ease;
    }

    .options-panel.show {
      display: block;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-4);
    }

    @media (max-width: 600px) {
      .options-grid {
        grid-template-columns: 1fr;
      }
    }

    .option-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .option-label {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--text-primary);
    }

    .option-select {
      padding: var(--space-3) var(--space-4);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      background: var(--bg-primary);
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition-fast);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    .option-select:hover {
      border-color: var(--border-medium);
    }

    .option-select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-focus);
    }

    /* Full width option group */
    .option-group-full {
      grid-column: 1 / -1;
    }

    /* Cover Image Upload Zone */
    .cover-upload-zone {
      border: 1px dashed var(--border-medium);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      cursor: pointer;
      transition: var(--transition-fast);
      background: var(--bg-secondary);
      position: relative;
    }

    .cover-upload-zone:hover {
      border-color: var(--accent-primary);
      background: var(--accent-light);
    }

    .cover-upload-zone.drag-over {
      border-color: var(--accent-primary);
      background: var(--accent-light);
    }

    .cover-upload-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .cover-upload-content i {
      width: 24px;
      height: 24px;
      color: var(--text-tertiary);
    }

    .cover-upload-content small {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    /* Cover Preview */
    .cover-preview {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .cover-preview img {
      width: 48px;
      height: 64px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-light);
    }

    .cover-preview-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cover-filename {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--text-primary);
    }

    .cover-dimensions {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    .cover-remove-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: var(--transition-fast);
    }

    .cover-remove-btn:hover {
      background: #FEE2E2;
      color: #DC2626;
    }

    .cover-remove-btn i {
      width: 16px;
      height: 16px;
    }

    /* Toggle Option */
    .toggle-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
    }

    .toggle-label {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .toggle-btn {
      width: 44px;
      height: 24px;
      border: none;
      border-radius: var(--radius-full);
      background: var(--border-medium);
      cursor: pointer;
      position: relative;
      transition: var(--transition-fast);
    }

    .toggle-btn.active {
      background: var(--accent-primary);
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: var(--transition-fast);
      box-shadow: var(--shadow-sm);
    }

    .toggle-btn.active .toggle-slider {
      left: 22px;
    }

    /* =============================================
       PRIMARY BUTTON
       ============================================= */

    .primary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-4) var(--space-8);
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: var(--font-size-base);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-normal);
      margin-top: var(--space-8);
      min-width: 200px;
    }

    .primary-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .primary-btn:active {
      transform: translateY(0);
    }

    .primary-btn:disabled {
      background: var(--border-medium);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .primary-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Button wrapper for centering */
    .button-wrapper {
      display: flex;
      justify-content: center;
      width: 100%;
      max-width: var(--max-width);
    }

    /* =============================================
       FILE PREVIEW (After Upload)
       ============================================= */

    .file-preview {
      display: none;
      width: 100%;
      max-width: var(--max-width);
      padding: var(--space-6);
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      margin-top: var(--space-6);
    }

    .file-preview.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .file-icon {
      width: 48px;
      height: 48px;
      background: var(--accent-light);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-primary);
      flex-shrink: 0;
    }

    .file-icon svg {
      width: 24px;
      height: 24px;
    }

    .file-details {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-meta {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-top: var(--space-1);
    }

    .file-remove {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
    }

    .file-remove:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .file-remove svg {
      width: 18px;
      height: 18px;
    }

    /* =============================================
       ENHANCED PROGRESS UI - Long Running Tasks
       ============================================= */

    .progress-section {
      display: none;
      width: 100%;
      max-width: 800px;
      margin-top: var(--space-8);
    }

    .progress-section.show {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    /* Progress Header with Stats */
    .progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-6);
    }

    .progress-title-area {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .progress-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--bg-tertiary);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .progress-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .progress-subtitle {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-top: var(--space-1);
    }

    .background-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--bg-tertiary);
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .background-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .background-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Main Progress Card */
    .progress-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
    }

    /* Progress Bar */
    .progress-bar-container {
      margin-bottom: var(--space-6);
    }

    .progress-bar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
    }

    .progress-percentage {
      font-size: var(--font-size-2xl);
      font-weight: 600;
      color: var(--accent-primary);
    }

    .progress-eta {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), #E8967D);
      border-radius: var(--radius-full);
      width: 0%;
      transition: width 0.5s ease;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-4);
      padding-top: var(--space-6);
      border-top: 1px solid var(--border-light);
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-1);
    }

    .stat-label {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin: var(--space-6) 0;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 40px;
      right: 40px;
      height: 2px;
      background: var(--bg-tertiary);
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
      position: relative;
      z-index: 1;
    }

    .step-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: var(--bg-primary);
      border: 2px solid var(--border-medium);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-tertiary);
      transition: var(--transition-normal);
    }

    .step.active .step-icon {
      background: var(--accent-light);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      animation: pulse 2s infinite;
    }

    .step.completed .step-icon {
      background: #10B981;
      border-color: #10B981;
      color: white;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(217, 119, 87, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(217, 119, 87, 0); }
    }

    .step-icon svg {
      width: 16px;
      height: 16px;
    }

    .step-label {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      font-weight: 500;
    }

    .step.active .step-label {
      color: var(--accent-primary);
    }

    .step.completed .step-label {
      color: #10B981;
    }

    /* Live Preview Section */
    .preview-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      overflow: hidden;
      margin-bottom: var(--space-6);
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border-light);
    }

    .preview-title {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--text-primary);
    }

    .preview-title svg {
      width: 16px;
      height: 16px;
      color: var(--accent-primary);
    }

    .preview-tabs {
      display: flex;
      gap: var(--space-1);
    }

    .preview-tab {
      padding: var(--space-2) var(--space-3);
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      font-size: var(--font-size-sm);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .preview-tab:hover {
      background: var(--bg-hover);
    }

    .preview-tab.active {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .preview-content {
      padding: var(--space-6);
      max-height: 200px;
      overflow-y: auto;
    }

    .preview-chunk {
      padding: var(--space-4);
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
      border-left: 3px solid var(--accent-primary);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .preview-chunk-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-2);
    }

    .chunk-badge {
      font-size: var(--font-size-xs);
      color: var(--accent-primary);
      font-weight: 500;
    }

    .chunk-time {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    .preview-text {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .preview-empty {
      text-align: center;
      padding: var(--space-8);
      color: var(--text-tertiary);
    }

    .preview-empty svg {
      width: 32px;
      height: 32px;
      margin-bottom: var(--space-3);
      opacity: 0.5;
    }

    /* Activity Log */
    .activity-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      overflow: hidden;
    }

    .activity-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border-light);
    }

    .activity-title {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--text-primary);
    }

    .activity-title svg {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
    }

    .activity-badge {
      padding: var(--space-1) var(--space-2);
      background: var(--accent-light);
      color: var(--accent-primary);
      font-size: var(--font-size-xs);
      font-weight: 500;
      border-radius: var(--radius-sm);
    }

    .activity-list {
      max-height: 150px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-6);
      border-bottom: 1px solid var(--border-light);
      animation: fadeIn 0.3s ease;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-primary);
      margin-top: 6px;
      flex-shrink: 0;
    }

    .activity-dot.success {
      background: #10B981;
    }

    .activity-dot.warning {
      background: #F59E0B;
    }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-message {
      font-size: var(--font-size-sm);
      color: var(--text-primary);
    }

    .activity-time {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-top: var(--space-1);
    }

    /* Tips Section */
    .tips-section {
      margin-top: var(--space-6);
      padding: var(--space-4) var(--space-6);
      background: var(--accent-light);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .tips-icon {
      width: 40px;
      height: 40px;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-primary);
      flex-shrink: 0;
    }

    .tips-icon svg {
      width: 20px;
      height: 20px;
    }

    .tips-content {
      flex: 1;
    }

    .tips-title {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: var(--space-1);
    }

    .tips-text {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .progress-steps {
        flex-direction: column;
        gap: var(--space-4);
      }

      .progress-steps::before {
        display: none;
      }

      .step {
        flex-direction: row;
        justify-content: flex-start;
        gap: var(--space-3);
      }

      .progress-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-4);
      }

      .background-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* =============================================
       DOWNLOAD FORMAT SELECTOR
       ============================================= */

    .download-section {
      display: none;
      width: 100%;
      max-width: 800px;
      margin-top: var(--space-6);
      animation: fadeIn 0.4s ease;
    }

    .download-section.show {
      display: block;
    }

    .download-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
    }

    .download-header {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }

    .download-icon {
      width: 48px;
      height: 48px;
      background: #10B981;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .download-icon svg {
      width: 24px;
      height: 24px;
    }

    .download-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .download-subtitle {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-top: var(--space-1);
    }

    .download-formats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-3);
    }

    @media (max-width: 600px) {
      .download-formats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .format-card {
      background: var(--bg-primary);
      border: 2px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      text-align: center;
      cursor: pointer;
      transition: var(--transition-normal);
      position: relative;
    }

    .format-card:hover {
      border-color: var(--accent-primary);
      background: var(--accent-light);
    }

    .format-card.downloading {
      pointer-events: none;
      opacity: 0.7;
    }

    .format-card-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto var(--space-3);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .format-card-icon.pdf {
      background: #FEE2E2;
      color: #DC2626;
    }

    .format-card-icon.docx {
      background: #DBEAFE;
      color: #2563EB;
    }

    .format-card-icon.txt {
      background: #E5E7EB;
      color: #374151;
    }

    .format-card-icon.md {
      background: #D1FAE5;
      color: #059669;
    }

    .format-card-name {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: var(--space-1);
    }

    .format-card-desc {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    .format-card-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-light);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .format-card-check {
      position: absolute;
      top: var(--space-2);
      right: var(--space-2);
      width: 20px;
      height: 20px;
      background: #10B981;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .format-card-check svg {
      width: 12px;
      height: 12px;
    }

    .format-card.downloaded .format-card-check {
      display: flex;
    }

    /* =============================================
       FOOTER
       ============================================= */

    .footer {
      padding: var(--space-6);
      text-align: center;
      margin-top: auto;
    }

    .footer-text {
      font-size: 0.65rem;
      color: var(--text-tertiary);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .footer-link {
      color: var(--accent-primary);
      text-decoration: none;
    }

    .footer-link:hover {
      text-decoration: underline;
    }

    /* =============================================
       THEME SYSTEM - Light & Dark
       ============================================= */

    /* Light Theme (Default) - High Contrast */
    [data-theme="light"] {
      --bg-primary: #FFFFFF;
      --bg-secondary: #F3F4F6;
      --bg-tertiary: #E5E7EB;
      --bg-hover: #E8EAED;
      --text-primary: #111827;
      --text-secondary: #4B5563;
      --text-tertiary: #6B7280;
      --text-inverse: #FFFFFF;
      --border-light: #D1D5DB;
      --border-medium: #9CA3AF;
      --accent-light: #FEF2EE;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    /* Dark Theme */
    [data-theme="dark"] {
      --bg-primary: #1A1A1A;
      --bg-secondary: #242424;
      --bg-tertiary: #2E2E2E;
      --bg-hover: #333333;
      --text-primary: #FAFAFA;
      --text-secondary: #A1A1A1;
      --text-tertiary: #737373;
      --text-inverse: #1A1A1A;
      --border-light: #333333;
      --border-medium: #444444;
      --accent-light: rgba(217, 119, 87, 0.15);
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    /* System preference fallback */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) {
        --bg-primary: #1A1A1A;
        --bg-secondary: #242424;
        --bg-tertiary: #2E2E2E;
        --bg-hover: #333333;
        --text-primary: #FAFAFA;
        --text-secondary: #A1A1A1;
        --text-tertiary: #737373;
        --border-light: #333333;
        --border-medium: #444444;
        --accent-light: rgba(217, 119, 87, 0.15);
      }
    }

    /* =============================================
       SLIDE PANEL (History & Settings)
       ============================================= */

    .slide-panel-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-normal);
      z-index: 200;
    }

    .slide-panel-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .slide-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      max-width: 100vw;
      height: 100vh;
      background: var(--bg-primary);
      box-shadow: var(--shadow-lg);
      transition: right 0.3s ease;
      z-index: 201;
      display: flex;
      flex-direction: column;
    }

    .slide-panel.show {
      right: 0;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border-light);
    }

    .panel-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .panel-close {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
    }

    .panel-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .panel-close svg {
      width: 20px;
      height: 20px;
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4);
    }

    /* =============================================
       HISTORY PANEL
       ============================================= */

    .history-empty {
      text-align: center;
      padding: var(--space-12) var(--space-6);
      color: var(--text-tertiary);
    }

    .history-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: var(--space-4);
      opacity: 0.5;
    }

    .history-empty-title {
      font-size: var(--font-size-base);
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: var(--space-2);
    }

    .history-empty-text {
      font-size: var(--font-size-sm);
    }

    .history-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-3);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .history-item:hover {
      background: var(--bg-hover);
    }

    .history-item-icon {
      width: 40px;
      height: 40px;
      background: var(--accent-light);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-primary);
      flex-shrink: 0;
    }

    .history-item-icon.success {
      background: #D1FAE5;
      color: #059669;
    }

    .history-item-icon.failed {
      background: #FEE2E2;
      color: #DC2626;
    }

    .history-item-icon.pending {
      background: #FEF3C7;
      color: #D97706;
    }

    .history-item-icon svg {
      width: 20px;
      height: 20px;
    }

    .history-item-content {
      flex: 1;
      min-width: 0;
    }

    .history-item-name {
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: var(--space-1);
    }

    .history-item-meta {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .history-item-status {
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: 500;
    }

    .history-item-status.success {
      background: #D1FAE5;
      color: #059669;
    }

    .history-item-status.failed {
      background: #FEE2E2;
      color: #DC2626;
    }

    .history-item-status.pending {
      background: #FEF3C7;
      color: #D97706;
    }

    .history-clear {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      width: 100%;
      padding: var(--space-3);
      margin-top: var(--space-4);
      background: transparent;
      border: 1px dashed var(--border-medium);
      border-radius: var(--radius-md);
      color: var(--text-tertiary);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .history-clear:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
      border-color: var(--text-tertiary);
    }

    .history-clear svg {
      width: 16px;
      height: 16px;
    }

    /* =============================================
       SETTINGS PANEL
       ============================================= */

    .settings-section {
      margin-bottom: var(--space-6);
    }

    .settings-section-title {
      font-size: var(--font-size-xs);
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-3);
      padding: 0 var(--space-2);
    }

    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-2);
    }

    .settings-item-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .settings-item-icon {
      width: 36px;
      height: 36px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }

    .settings-item-icon svg {
      width: 18px;
      height: 18px;
    }

    .settings-item-label {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: var(--space-1);
    }

    .settings-item-desc {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    /* Theme Toggle Switch */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1);
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
    }

    .theme-option {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .theme-option:hover {
      color: var(--text-secondary);
    }

    .theme-option.active {
      background: var(--bg-primary);
      color: var(--accent-primary);
      box-shadow: var(--shadow-sm);
    }

    .theme-option svg {
      width: 18px;
      height: 18px;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 28px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition-normal);
    }

    .toggle-switch.active {
      background: var(--accent-primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: var(--bg-primary);
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-sm);
      transition: var(--transition-normal);
    }

    .toggle-switch.active::after {
      left: 23px;
    }

    /* API Key Input */
    .settings-input-group {
      margin-top: var(--space-3);
    }

    .settings-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      transition: var(--transition-fast);
    }

    .settings-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-focus);
    }

    .settings-input::placeholder {
      color: var(--text-tertiary);
    }

    .settings-save-btn {
      margin-top: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .settings-save-btn:hover {
      background: var(--accent-hover);
    }

    .settings-save-btn:disabled {
      background: var(--border-medium);
      cursor: not-allowed;
    }

    /* Version Info */
    .settings-version {
      text-align: center;
      padding: var(--space-6);
      border-top: 1px solid var(--border-light);
      margin-top: auto;
    }

    .settings-version-text {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    .settings-version-link {
      color: var(--accent-primary);
      text-decoration: none;
    }

    .settings-version-link:hover {
      text-decoration: underline;
    }

    /* Engine Selector Styles */
    .engine-selector {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .engine-selector select.settings-input {
      padding: var(--space-4);
      min-height: 48px;
      font-size: var(--font-size-base);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    .engine-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      margin-top: var(--space-2);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-tertiary);
      animation: pulse 2s infinite;
    }

    .status-dot.available {
      background: #22c55e;
      animation: none;
    }

    .status-dot.unavailable {
      background: #ef4444;
      animation: none;
    }

    .status-dot.loading {
      background: #f59e0b;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Engine Info Panel */
    .engine-info-panel {
      margin-top: var(--space-3);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      overflow: hidden;
      background: var(--bg-secondary);
    }

    .engine-info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) var(--space-3);
      cursor: pointer;
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
    }

    .engine-info-header:hover {
      background: var(--bg-hover);
    }

    .engine-info-content {
      padding: var(--space-3);
      border-top: 1px solid var(--border-light);
      font-size: var(--font-size-xs);
    }

    .engine-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2);
    }

    .engine-stat {
      display: flex;
      justify-content: space-between;
      padding: var(--space-1) 0;
    }

    .engine-stat-label {
      color: var(--text-secondary);
    }

    .engine-stat-value {
      font-weight: 500;
      color: var(--text-primary);
    }

    .engine-stat-value.free {
      color: #22c55e;
    }

    /* Dark mode support for engine selector */
    [data-theme="dark"] .engine-info-panel {
      background: var(--bg-tertiary);
      border-color: var(--border-medium);
    }

    [data-theme="dark"] .engine-info-header:hover {
      background: var(--bg-hover);
    }

    [data-theme="dark"] .engine-info-content {
      border-color: var(--border-medium);
    }

    /* Mobile Panel */
    @media (max-width: 480px) {
      .slide-panel {
        width: 100vw;
        right: -100vw;
      }
    }

    /* =============================================
       BATCH FILE QUEUE
       ============================================= */

    .file-queue {
      display: none;
      width: 100%;
      max-width: var(--max-width);
      margin-top: var(--space-6);
    }

    .file-queue.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .file-queue-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }

    .file-queue-title {
      font-size: var(--font-size-base);
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .file-queue-title svg {
      width: 18px;
      height: 18px;
      color: var(--accent-primary);
    }

    .file-queue-count {
      padding: var(--space-1) var(--space-3);
      background: var(--accent-light);
      color: var(--accent-primary);
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: 600;
    }

    .file-queue-actions {
      display: flex;
      gap: var(--space-2);
    }

    .queue-action-btn {
      padding: var(--space-2) var(--space-3);
      background: transparent;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .queue-action-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-medium);
    }

    .queue-action-btn svg {
      width: 14px;
      height: 14px;
    }

    .file-queue-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      max-height: 300px;
      overflow-y: auto;
    }

    .queue-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      transition: var(--transition-fast);
    }

    .queue-item:hover {
      background: var(--bg-hover);
    }

    .queue-item.processing {
      border-color: var(--accent-primary);
      background: var(--accent-light);
    }

    .queue-item.completed {
      border-color: #10B981;
      background: #F0FDF4;
    }

    .queue-item.failed {
      border-color: #EF4444;
      background: #FEF2F2;
    }

    .queue-item-icon {
      width: 36px;
      height: 36px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .queue-item.processing .queue-item-icon {
      background: var(--accent-primary);
      color: white;
    }

    .queue-item.completed .queue-item-icon {
      background: #10B981;
      color: white;
    }

    .queue-item.failed .queue-item-icon {
      background: #EF4444;
      color: white;
    }

    .queue-item-icon svg {
      width: 18px;
      height: 18px;
    }

    .queue-item-info {
      flex: 1;
      min-width: 0;
    }

    .queue-item-name {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .queue-item-meta {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-top: var(--space-1);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .queue-item-progress {
      flex: 0 0 100px;
    }

    .queue-item-progress-bar {
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .queue-item-progress-fill {
      height: 100%;
      background: var(--accent-primary);
      border-radius: var(--radius-full);
      transition: width 0.3s ease;
    }

    .queue-item.completed .queue-item-progress-fill {
      background: #10B981;
    }

    .queue-item-progress-text {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      text-align: right;
      margin-top: var(--space-1);
    }

    .queue-item-remove {
      width: 28px;
      height: 28px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-tertiary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
    }

    .queue-item-remove:hover {
      background: var(--bg-hover);
      color: #EF4444;
    }

    .queue-item-remove svg {
      width: 16px;
      height: 16px;
    }

    .queue-item.processing .queue-item-remove,
    .queue-item.completed .queue-item-remove {
      display: none;
    }

    /* Batch Summary */
    .batch-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
    }

    .batch-summary-stats {
      display: flex;
      gap: var(--space-6);
    }

    .batch-stat {
      text-align: center;
    }

    .batch-stat-value {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .batch-stat-label {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-top: var(--space-1);
    }

    .batch-stat-value.success {
      color: #10B981;
    }

    .batch-stat-value.failed {
      color: #EF4444;
    }

    /* =============================================
       LOADING SPINNER
       ============================================= */

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* =============================================
       RESPONSIVE
       ============================================= */

    @media (max-width: 768px) {
      .main-content {
        padding: var(--space-10) var(--space-4);
      }

      .hero-title {
        font-size: var(--font-size-2xl);
      }

      .upload-zone {
        padding: var(--space-10) var(--space-4);
      }

      .progress-steps {
        flex-direction: column;
        gap: var(--space-4);
      }

      .header {
        padding: 0 var(--space-4);
      }

      .hero {
        margin-bottom: var(--space-8);
      }

      .hero-subtitle {
        font-size: var(--font-size-sm);
      }

      .preview-section {
        margin-top: var(--space-6);
      }

      .options-section {
        padding: var(--space-4);
      }
    }

    @media (max-width: 480px) {
      .main-content {
        padding: var(--space-6) var(--space-3);
      }

      .hero-title {
        font-size: var(--font-size-xl);
      }

      .hero-badge {
        font-size: var(--font-size-xs);
      }

      .upload-zone {
        padding: var(--space-8) var(--space-3);
      }

      .upload-icon {
        width: 40px;
        height: 40px;
      }

      .upload-title {
        font-size: var(--font-size-base);
      }

      .upload-subtitle {
        font-size: var(--font-size-xs);
      }

      .file-preview {
        padding: var(--space-4);
      }

      .preview-tabs {
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      .preview-tab {
        font-size: var(--font-size-xs);
        padding: var(--space-2) var(--space-3);
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-2);
      }

      .stat-card {
        padding: var(--space-3);
      }

      .stat-value {
        font-size: var(--font-size-lg);
      }

      .submit-btn {
        padding: var(--space-4) var(--space-6);
        font-size: var(--font-size-base);
      }

      .download-header h2 {
        font-size: var(--font-size-lg);
      }

      .format-card {
        padding: var(--space-3);
      }

      .format-card-name {
        font-size: var(--font-size-sm);
      }
    }

    /* =============================================
       DARK MODE ENHANCEMENTS
       ============================================= */

    /* Ensure all inputs/selects work in dark mode */
    [data-theme="dark"] .option-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23A1A1A1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    }

    [data-theme="dark"] .settings-input {
      background: var(--bg-tertiary);
    }

    [data-theme="dark"] .slide-panel-overlay {
      background: rgba(0, 0, 0, 0.6);
    }

    [data-theme="dark"] .upload-zone:hover {
      background: var(--bg-tertiary);
    }

    [data-theme="dark"] .file-preview {
      background: var(--bg-secondary);
    }

    [data-theme="dark"] .preview-section {
      background: var(--bg-secondary);
    }

    [data-theme="dark"] .format-card:hover {
      background: var(--bg-tertiary);
    }

    [data-theme="dark"] .activity-section {
      background: var(--bg-secondary);
    }

    [data-theme="dark"] .chunk-badge {
      background: var(--bg-tertiary);
    }

    [data-theme="dark"] .toast {
      background: var(--bg-tertiary);
      border-color: var(--border-medium);
    }

    /* System dark mode fallback */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) .option-select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23A1A1A1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
      }

      :root:not([data-theme]) .slide-panel-overlay {
        background: rgba(0, 0, 0, 0.6);
      }

      :root:not([data-theme]) .upload-zone:hover,
      :root:not([data-theme]) .file-preview,
      :root:not([data-theme]) .preview-section,
      :root:not([data-theme]) .activity-section {
        background: var(--bg-secondary);
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <a href="#" class="logo">
        <span>AI Publisher</span>
      </a>
      <div class="header-actions">
        <button class="header-btn" id="history-btn" title="Lịch sử">
          <i data-lucide="clock"></i>
        </button>
        <button class="header-btn" id="settings-btn" title="Cài đặt">
          <i data-lucide="settings"></i>
        </button>
      </div>
    </header>

    <!-- History Panel -->
    <div class="slide-panel-overlay" id="history-overlay"></div>
    <div class="slide-panel" id="history-panel">
      <div class="panel-header">
        <h2 class="panel-title">Lịch sử</h2>
        <button class="panel-close" id="history-close">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="panel-content" id="history-content">
        <div class="history-empty" id="history-empty">
          <i data-lucide="inbox"></i>
          <div class="history-empty-title">Chưa có lịch sử</div>
          <div class="history-empty-text">Các tài liệu đã xử lý sẽ hiển thị ở đây</div>
        </div>
        <div id="history-list"></div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="slide-panel-overlay" id="settings-overlay"></div>
    <div class="slide-panel" id="settings-panel">
      <div class="panel-header">
        <h2 class="panel-title">Cài đặt</h2>
        <button class="panel-close" id="settings-close">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="panel-content">
        <!-- Appearance Section -->
        <div class="settings-section">
          <div class="settings-section-title">Giao diện</div>
          <div class="settings-item">
            <div class="settings-item-info">
              <div class="settings-item-icon">
                <i data-lucide="palette"></i>
              </div>
              <div>
                <div class="settings-item-label">Chủ đề</div>
                <div class="settings-item-desc">Chọn giao diện sáng hoặc tối</div>
              </div>
            </div>
            <div class="theme-toggle" id="theme-toggle">
              <button class="theme-option" data-theme="light" title="Sáng">
                <i data-lucide="sun"></i>
              </button>
              <button class="theme-option" data-theme="dark" title="Tối">
                <i data-lucide="moon"></i>
              </button>
              <button class="theme-option" data-theme="system" title="Hệ thống">
                <i data-lucide="monitor"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- API Section -->
        <div class="settings-section">
          <div class="settings-section-title">API Keys</div>

          <!-- OpenAI API Key -->
          <div class="settings-item" style="flex-direction: column; align-items: stretch; margin-bottom: var(--space-4);">
            <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
              <div class="settings-item-icon" style="background: linear-gradient(135deg, #10a37f 0%, #1a7f5a 100%);">
                <i data-lucide="sparkles"></i>
              </div>
              <div>
                <div class="settings-item-label">OpenAI API Key</div>
                <div class="settings-item-desc">GPT-4o, GPT-4o Mini</div>
              </div>
            </div>
            <div class="settings-input-group">
              <input type="password" class="settings-input" id="api-key-input" placeholder="sk-...">
              <button class="settings-save-btn" id="save-api-key">Lưu</button>
            </div>
          </div>

          <!-- Anthropic API Key -->
          <div class="settings-item" style="flex-direction: column; align-items: stretch;">
            <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
              <div class="settings-item-icon" style="background: linear-gradient(135deg, #cc785c 0%, #b8624a 100%);">
                <i data-lucide="brain"></i>
              </div>
              <div>
                <div class="settings-item-label">Anthropic API Key</div>
                <div class="settings-item-desc">Claude Sonnet 4, Claude Opus 4</div>
              </div>
            </div>
            <div class="settings-input-group">
              <input type="password" class="settings-input" id="anthropic-api-key-input" placeholder="sk-ant-...">
              <button class="settings-save-btn" id="save-anthropic-api-key">Lưu</button>
            </div>
          </div>
        </div>

        <!-- Translation Engine Section -->
        <div class="settings-section">
          <div class="settings-section-title">Translation Engine</div>
          <div class="settings-item" style="flex-direction: column; align-items: stretch;">
            <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
              <div class="settings-item-icon" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                <i data-lucide="layers"></i>
              </div>
              <div>
                <div class="settings-item-label">Engine</div>
                <div class="settings-item-desc">Chọn engine dịch thuật</div>
              </div>
            </div>
            <div class="engine-selector">
              <select id="translation-engine" class="settings-input" style="width: 100%;">
                <option value="auto">Auto - Best Available</option>
                <option value="translategemma_4b">TranslateGemma 4B (Local/Free)</option>
                <option value="cloud_api_auto">Cloud API (GPT/Claude)</option>
              </select>
              <div id="engine-status" class="engine-status">
                <span class="status-dot"></span>
                <span class="status-text">Checking...</span>
              </div>
            </div>
          </div>
          <!-- Engine Info Panel -->
          <div class="engine-info-panel" id="engine-info-panel">
            <div class="engine-info-header" onclick="toggleEngineInfo()">
              <span>ℹ️ Engine Details</span>
              <span class="chevron">▼</span>
            </div>
            <div class="engine-info-content" id="engine-info-content" style="display: none;">
              <div class="engine-stats" id="engine-stats">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
        </div>

        <!-- Preferences Section -->
        <div class="settings-section">
          <div class="settings-section-title">Tùy chọn</div>
          <div class="settings-item">
            <div class="settings-item-info">
              <div class="settings-item-icon">
                <i data-lucide="bell"></i>
              </div>
              <div>
                <div class="settings-item-label">Thông báo</div>
                <div class="settings-item-desc">Nhận thông báo khi hoàn thành</div>
              </div>
            </div>
            <div class="toggle-switch" id="notification-toggle"></div>
          </div>
          <div class="settings-item">
            <div class="settings-item-info">
              <div class="settings-item-icon">
                <i data-lucide="save"></i>
              </div>
              <div>
                <div class="settings-item-label">Tự động lưu</div>
                <div class="settings-item-desc">Lưu cài đặt vào trình duyệt</div>
              </div>
            </div>
            <div class="toggle-switch active" id="autosave-toggle"></div>
          </div>
        </div>
      </div>

      <!-- Version -->
      <div class="settings-version">
        <div class="settings-version-text">
          AI Publisher Pro v2.8.0<br>
          <a href="https://github.com/nclamvn/ai-translator-pro" class="settings-version-link" target="_blank">GitHub</a>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Hero Section -->
      <section class="hero">
        <div class="hero-badge">
          <i data-lucide="zap"></i>
          <span>Powered by AI</span>
        </div>
        <h1 class="hero-title">Dịch và xuất bản tài liệu<br>chuyên nghiệp</h1>
        <p class="hero-subtitle">
          Tải lên tài liệu của bạn và để AI xử lý việc còn lại.
          Nhanh chóng, chính xác, đa định dạng.
        </p>

        <!-- Mode Selector -->
        <div style="display: flex; justify-content: center; gap: var(--space-4); margin-top: var(--space-8);">
          <a href="/app" class="header-btn" style="width: auto; height: auto; padding: var(--space-2) var(--space-4); background: var(--bg-hover); color: var(--accent-primary); border: 1px solid var(--accent-primary);">
            <i data-lucide="languages" style="width: 16px; height: 16px; margin-right: 8px;"></i>
            Dịch thuật
          </a>
          <a href="/write" class="header-btn" style="width: auto; height: auto; padding: var(--space-2) var(--space-4);">
            <i data-lucide="pen-tool" style="width: 16px; height: 16px; margin-right: 8px;"></i>
            Viết sách AI
          </a>
        </div>
      </section>

      <!-- Upload Zone -->
      <div class="upload-container">
        <div class="upload-zone" id="upload-zone">
          <div class="upload-content">
            <div class="upload-icon">
              <i data-lucide="upload-cloud"></i>
            </div>
            <p class="upload-text">
              Kéo thả tài liệu vào đây hoặc
              <span class="upload-text-link">chọn file</span>
            </p>
            <p class="upload-hint">Hỗ trợ PDF, DOCX, TXT, MD (tối đa 50MB)</p>
            <div class="upload-formats">
              <span class="format-tag">PDF</span>
              <span class="format-tag">DOCX</span>
              <span class="format-tag">TXT</span>
              <span class="format-tag">MD</span>
            </div>
          </div>
          <input type="file" class="upload-input" id="file-input"
                 accept=".pdf,.docx,.txt,.md,.tex" multiple>
        </div>
      </div>

      <!-- File Queue (for batch processing) -->
      <div class="file-queue" id="file-queue">
        <div class="file-queue-header">
          <div class="file-queue-title">
            <i data-lucide="layers"></i>
            <span>Hàng đợi xử lý</span>
            <span class="file-queue-count" id="queue-count">0 tệp</span>
          </div>
          <div class="file-queue-actions">
            <button class="queue-action-btn" id="add-more-files" title="Thêm tệp">
              <i data-lucide="plus"></i>
              <span>Thêm</span>
            </button>
            <button class="queue-action-btn" id="clear-queue" title="Xóa tất cả">
              <i data-lucide="trash-2"></i>
              <span>Xóa hết</span>
            </button>
          </div>
        </div>
        <div class="file-queue-list" id="queue-list">
          <!-- Queue items will be added here dynamically -->
        </div>
        <div class="batch-summary" id="batch-summary" style="display: none;">
          <div class="batch-summary-stats">
            <div class="batch-stat">
              <div class="batch-stat-value" id="batch-total">0</div>
              <div class="batch-stat-label">Tổng</div>
            </div>
            <div class="batch-stat">
              <div class="batch-stat-value success" id="batch-completed">0</div>
              <div class="batch-stat-label">Hoàn thành</div>
            </div>
            <div class="batch-stat">
              <div class="batch-stat-value failed" id="batch-failed">0</div>
              <div class="batch-stat-label">Thất bại</div>
            </div>
          </div>
        </div>
      </div>

      <!-- File Preview (Hidden by default - for single file mode) -->
      <div class="file-preview" id="file-preview">
        <div class="file-info">
          <div class="file-icon">
            <i data-lucide="file-text"></i>
          </div>
          <div class="file-details">
            <div class="file-name" id="file-name">document.pdf</div>
            <div class="file-meta" id="file-meta">2.4 MB • PDF Document</div>
          </div>
          <button class="file-remove" id="file-remove" title="Remove file">
            <i data-lucide="x"></i>
          </button>
        </div>
      </div>

      <!-- Options (Progressive Disclosure) -->
      <section class="options-section">
        <button class="options-toggle" id="options-toggle">
          <span>Tùy chọn nâng cao</span>
          <i data-lucide="chevron-down"></i>
        </button>

        <div class="options-panel" id="options-panel">
          <div class="options-grid">
            <div class="option-group">
              <label class="option-label">Hồ sơ xuất bản</label>
              <select class="option-select" id="profile-select">
                <option value="academic">Academic / Research</option>
                <option value="business">Business / Professional</option>
                <option value="book">Book / Literature</option>
                <option value="technical">Technical Documentation</option>
              </select>
            </div>
            <div class="option-group">
              <label class="option-label">Mô hình Dịch thuật</label>
              <select class="option-select" id="model-select">
                <optgroup label="Khuyên dùng">
                  <option value="gpt-4o">GPT-4o (Nhanh, Chính xác)</option>
                  <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Chất lượng cao)</option>
                </optgroup>
                <optgroup label="OpenAI">
                  <option value="gpt-4o-mini">GPT-4o Mini (Tiết kiệm)</option>
                </optgroup>
                <optgroup label="Anthropic Claude">
                  <option value="claude-opus-4-20250514">Claude Opus 4 (Tốt nhất)</option>
                  <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                  <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku (Nhanh)</option>
                </optgroup>
              </select>
              <small style="color: var(--text-muted); font-size: 11px; margin-top: 4px; display: block;">
                Vision Layout luôn dùng Claude Vision (ưu tiên) cho đọc PDF
              </small>
            </div>
            <div class="option-group">
              <label class="option-label">Ngôn ngữ nguồn</label>
              <select class="option-select" id="source-lang">
                <option value="auto">Tự động phát hiện</option>
                <option value="en">English</option>
                <option value="zh">中文</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
              </select>
            </div>
            <div class="option-group">
              <label class="option-label">Ngôn ngữ đích</label>
              <select class="option-select" id="target-lang">
                <option value="vi">Tiếng Việt</option>
                <option value="en">English</option>
                <option value="zh">中文</option>
                <option value="ja">日本語</option>
              </select>
            </div>
            <div class="option-group">
              <label class="option-label">Kiểu DOCX</label>
              <select class="option-select" id="docx-template">
                <option value="auto">Tự động chọn</option>
                <option value="ebook">Ebook (Sách văn học)</option>
                <option value="academic">Academic (Học thuật)</option>
                <option value="business">Business (Doanh nghiệp)</option>
              </select>
            </div>
            <div class="option-group">
              <label class="option-label">Kiểu PDF</label>
              <select class="option-select" id="pdf-template">
                <option value="auto">Tự động chọn</option>
                <option value="ebook">Ebook (14×21.5cm, Serif)</option>
                <option value="academic">Academic (A4, 1.5 dòng)</option>
                <option value="business">Business (A4, Sans-serif)</option>
              </select>
            </div>

            <!-- Cover Image Upload (NEW) -->
            <div class="option-group option-group-full">
              <label class="option-label">
                <i data-lucide="image" style="width: 14px; height: 14px; margin-right: 6px;"></i>
                Ảnh bìa (Tùy chọn)
              </label>
              <div class="cover-upload-zone" id="cover-upload-zone">
                <input type="file" id="cover-file-input" accept="image/png,image/jpeg,image/webp" hidden>
                <div class="cover-upload-content" id="cover-upload-content">
                  <i data-lucide="image-plus"></i>
                  <span>Kéo thả hoặc click để chọn ảnh bìa</span>
                  <small>PNG, JPG, WebP • Tối đa 5MB</small>
                </div>
                <div class="cover-preview" id="cover-preview" style="display: none;">
                  <img id="cover-preview-img" alt="Cover preview">
                  <div class="cover-preview-info">
                    <span class="cover-filename" id="cover-filename">cover.jpg</span>
                    <span class="cover-dimensions" id="cover-dimensions">1200×1800</span>
                  </div>
                  <button class="cover-remove-btn" id="cover-remove-btn" type="button">
                    <i data-lucide="x"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Include Images Toggle (NEW) -->
            <div class="option-group option-group-full">
              <label class="option-label">
                <i data-lucide="images" style="width: 14px; height: 14px; margin-right: 6px;"></i>
                Trích xuất ảnh từ PDF
              </label>
              <div class="toggle-option">
                <span class="toggle-label">Giữ lại ảnh minh họa trong tài liệu gốc</span>
                <button class="toggle-btn active" id="include-images-toggle" type="button">
                  <span class="toggle-slider"></span>
                </button>
              </div>
            </div>

            <!-- Vision Layout Toggle (Phase 2026-02) -->
            <div class="option-group option-group-full">
              <label class="option-label">
                <i data-lucide="scan-eye" style="width: 14px; height: 14px; margin-right: 6px;"></i>
                Vision Layout (Claude Vision ưu tiên)
              </label>
              <div class="toggle-option">
                <span class="toggle-label">Đọc PDF bằng AI Vision - giữ bảng, công thức, layout</span>
                <button class="toggle-btn active" id="use-vision-toggle" type="button">
                  <span class="toggle-slider"></span>
                </button>
              </div>
              <small style="color: var(--text-muted); font-size: 11px; margin-top: 4px; display: block;">
                ON = Claude Vision đọc PDF → Mô hình dịch thuật (ở trên) dịch
              </small>
            </div>
          </div>
        </div>
      </section>

      <!-- Submit Button -->
      <div class="button-wrapper">
        <button class="primary-btn" id="submit-btn" disabled>
          <i data-lucide="sparkles"></i>
          <span>Bắt đầu xử lý</span>
        </button>
      </div>

      <!-- Enhanced Progress Section (Hidden by default) -->
      <section class="progress-section" id="progress-section">
        <!-- Progress Header -->
        <div class="progress-header">
          <div class="progress-title-area">
            <div class="progress-spinner" id="progress-spinner"></div>
            <div>
              <h2 class="progress-title" id="progress-title">Đang xử lý tài liệu</h2>
              <p class="progress-subtitle" id="progress-subtitle">document.pdf • 24 trang</p>
            </div>
          </div>
          <button class="background-btn" id="background-btn" title="Chạy ngầm và nhận thông báo khi hoàn thành">
            <i data-lucide="bell"></i>
            <span>Chạy ngầm</span>
          </button>
        </div>

        <!-- Progress Card with Stats -->
        <div class="progress-card">
          <!-- Progress Bar -->
          <div class="progress-bar-container">
            <div class="progress-bar-header">
              <span class="progress-percentage" id="progress-percentage">0%</span>
              <span class="progress-eta" id="progress-eta">Còn khoảng 15 phút</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
          </div>

          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="stat-chunks">0/48</div>
              <div class="stat-label">Chunks</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-time">00:00</div>
              <div class="stat-label">Thời gian</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-tokens">0</div>
              <div class="stat-label">Tokens</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-cost">$0.00</div>
              <div class="stat-label">Chi phí</div>
            </div>
          </div>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step active" id="step-1">
            <div class="step-icon">
              <i data-lucide="scan"></i>
            </div>
            <span class="step-label">Phân tích</span>
          </div>
          <div class="step" id="step-2">
            <div class="step-icon">
              <i data-lucide="languages"></i>
            </div>
            <span class="step-label">Dịch thuật</span>
          </div>
          <div class="step" id="step-3">
            <div class="step-icon">
              <i data-lucide="file-output"></i>
            </div>
            <span class="step-label">Xuất bản</span>
          </div>
        </div>

        <!-- Live Preview -->
        <div class="preview-section">
          <div class="preview-header">
            <div class="preview-title">
              <i data-lucide="eye"></i>
              <span>Xem trước bản dịch</span>
            </div>
            <div class="preview-tabs">
              <button class="preview-tab active" data-tab="translated">Bản dịch</button>
              <button class="preview-tab" data-tab="original">Gốc</button>
            </div>
          </div>
          <div class="preview-content" id="preview-content">
            <div class="preview-empty" id="preview-empty">
              <i data-lucide="file-text"></i>
              <p>Nội dung sẽ hiển thị khi có chunks hoàn thành</p>
            </div>
          </div>
        </div>

        <!-- Activity Log -->
        <div class="activity-section">
          <div class="activity-header">
            <div class="activity-title">
              <i data-lucide="activity"></i>
              <span>Hoạt động</span>
            </div>
            <span class="activity-badge" id="activity-count">0 sự kiện</span>
          </div>
          <div class="activity-list" id="activity-list">
            <!-- Activity items will be added here dynamically -->
          </div>
        </div>

        <!-- Tips -->
        <div class="tips-section" id="tips-section">
          <div class="tips-icon">
            <i data-lucide="lightbulb"></i>
          </div>
          <div class="tips-content">
            <div class="tips-title" id="tips-title">Bạn có biết?</div>
            <div class="tips-text" id="tips-text">AI Publisher Pro sử dụng mô hình ngôn ngữ tiên tiến để dịch chính xác thuật ngữ chuyên ngành.</div>
          </div>
        </div>
      </section>

      <!-- Download Section (Shown after processing complete) -->
      <section class="download-section" id="download-section">
        <div class="download-card">
          <div class="download-header">
            <div class="download-icon">
              <i data-lucide="check-circle"></i>
            </div>
            <div>
              <h2 class="download-title">Tài liệu đã sẵn sàng!</h2>
              <p class="download-subtitle" id="download-subtitle">Chọn định dạng để tải xuống</p>
            </div>
          </div>
          <div class="download-formats">
            <div class="format-card" data-format="pdf" onclick="downloadFormat('pdf')">
              <div class="format-card-check"><i data-lucide="check"></i></div>
              <div class="format-card-icon pdf">PDF</div>
              <div class="format-card-name">PDF</div>
              <div class="format-card-desc">Giữ nguyên layout</div>
            </div>
            <div class="format-card" data-format="docx" onclick="downloadFormat('docx')">
              <div class="format-card-check"><i data-lucide="check"></i></div>
              <div class="format-card-icon docx">DOC</div>
              <div class="format-card-name">DOCX</div>
              <div class="format-card-desc">Có thể chỉnh sửa</div>
            </div>
            <div class="format-card" data-format="txt" onclick="downloadFormat('txt')">
              <div class="format-card-check"><i data-lucide="check"></i></div>
              <div class="format-card-icon txt">TXT</div>
              <div class="format-card-name">TXT</div>
              <div class="format-card-desc">Văn bản thuần</div>
            </div>
            <div class="format-card" data-format="md" onclick="downloadFormat('md')">
              <div class="format-card-check"><i data-lucide="check"></i></div>
              <div class="format-card-icon md">MD</div>
              <div class="format-card-name">Markdown</div>
              <div class="format-card-desc">Dễ đọc, dễ chia sẻ</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <p class="footer-text">
        Powered by <a href="https://claude.ai" class="footer-link">Claude AI</a> •
        Built with Anthropic Technology
      </p>
    </footer>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // API Base URL
    const API_BASE = window.location.origin;

    // DOM Elements
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const fileMeta = document.getElementById('file-meta');
    const fileRemove = document.getElementById('file-remove');
    const optionsToggle = document.getElementById('options-toggle');
    const optionsPanel = document.getElementById('options-panel');
    const submitBtn = document.getElementById('submit-btn');
    const progressSection = document.getElementById('progress-section');
    const progressFill = document.getElementById('progress-fill');
    const backgroundBtn = document.getElementById('background-btn');
    const downloadSection = document.getElementById('download-section');

    let selectedFile = null;
    let serverFilePath = null; // Path returned from upload API
    let startTime = null;
    let timerInterval = null;
    let activityCount = 0;
    let isProcessingComplete = false;
    let currentJobId = null;
    let progressPollInterval = null;
    let previewData = []; // Store both original and translated
    let currentPreviewTab = 'translated';
    let downloadedFormats = new Set();

    // Cover Image State (NEW)
    let coverImageFile = null;
    let coverImageBase64 = null;
    let includeImages = true; // Default: extract images from PDF
    let useVision = true; // Default: use Vision API for layout preservation

    // Translation Engine State
    let availableEngines = [];
    let selectedEngine = 'auto';

    // Cover Image DOM Elements (NEW)
    const coverUploadZone = document.getElementById('cover-upload-zone');
    const coverFileInput = document.getElementById('cover-file-input');
    const coverUploadContent = document.getElementById('cover-upload-content');
    const coverPreview = document.getElementById('cover-preview');
    const coverPreviewImg = document.getElementById('cover-preview-img');
    const coverFilename = document.getElementById('cover-filename');
    const coverDimensions = document.getElementById('cover-dimensions');
    const coverRemoveBtn = document.getElementById('cover-remove-btn');
    const includeImagesToggle = document.getElementById('include-images-toggle');
    const useVisionToggle = document.getElementById('use-vision-toggle');

    // Tips data for rotating display
    const tips = [
      { title: 'Bạn có biết?', text: 'AI Publisher Pro sử dụng mô hình ngôn ngữ tiên tiến để dịch chính xác thuật ngữ chuyên ngành.' },
      { title: 'Mẹo hay', text: 'Bạn có thể chạy ngầm và làm việc khác. Chúng tôi sẽ thông báo khi hoàn thành.' },
      { title: 'Tính năng mới', text: 'Hỗ trợ giữ nguyên format bảng biểu và công thức toán học trong tài liệu PDF.' },
      { title: 'Tiết kiệm chi phí', text: 'Hệ thống cache thông minh giúp tiết kiệm đến 70% chi phí cho tài liệu tương tự.' },
      { title: 'Chất lượng cao', text: 'Thuật ngữ chuyên ngành được kiểm tra với glossary có sẵn hoặc tùy chỉnh.' },
    ];
    let currentTipIndex = 0;

    // Sample translated chunks for demo
    const sampleChunks = [
      { original: 'Artificial intelligence is transforming how we live and work.', translated: 'Trí tuệ nhân tạo đang thay đổi cách chúng ta sống và làm việc.' },
      { original: 'Machine learning algorithms can process vast amounts of data.', translated: 'Thuật toán học máy có thể xử lý lượng lớn dữ liệu.' },
      { original: 'The technology industry continues to grow rapidly.', translated: 'Ngành công nghệ tiếp tục phát triển nhanh chóng.' },
      { original: 'Cloud computing enables scalable solutions for businesses.', translated: 'Điện toán đám mây cho phép các giải pháp có khả năng mở rộng cho doanh nghiệp.' },
      { original: 'Natural language processing has made significant advances.', translated: 'Xử lý ngôn ngữ tự nhiên đã có những tiến bộ đáng kể.' },
    ];

    // Upload Zone Click
    uploadZone.addEventListener('click', () => {
      fileInput.click();
    });

    // Drag & Drop
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('drag-over');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFiles(Array.from(files));
      }
    });

    // File Input Change
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFiles(Array.from(e.target.files));
      }
    });

    // =============================================
    // COVER IMAGE UPLOAD (NEW)
    // =============================================

    // Cover Upload Zone Click
    if (coverUploadZone) {
      coverUploadZone.addEventListener('click', (e) => {
        if (e.target !== coverRemoveBtn && !coverRemoveBtn?.contains(e.target)) {
          coverFileInput?.click();
        }
      });

      // Drag & Drop for cover
      coverUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        coverUploadZone.classList.add('drag-over');
      });

      coverUploadZone.addEventListener('dragleave', () => {
        coverUploadZone.classList.remove('drag-over');
      });

      coverUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        coverUploadZone.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleCoverFile(files[0]);
        }
      });
    }

    // Cover File Input Change
    if (coverFileInput) {
      coverFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleCoverFile(e.target.files[0]);
        }
      });
    }

    // Cover Remove Button
    if (coverRemoveBtn) {
      coverRemoveBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeCoverImage();
      });
    }

    // Include Images Toggle
    if (includeImagesToggle) {
      includeImagesToggle.addEventListener('click', () => {
        includeImagesToggle.classList.toggle('active');
        includeImages = includeImagesToggle.classList.contains('active');
      });
    }

    // Vision Layout Toggle
    if (useVisionToggle) {
      useVisionToggle.addEventListener('click', () => {
        useVisionToggle.classList.toggle('active');
        useVision = useVisionToggle.classList.contains('active');
      });
    }

    // Handle Cover File Selection
    function handleCoverFile(file) {
      // Validate file type
      const validTypes = ['image/png', 'image/jpeg', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        showToast('Chỉ hỗ trợ PNG, JPG, WebP', 'error');
        return;
      }

      // Validate file size (max 5MB)
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast('Ảnh bìa tối đa 5MB', 'error');
        return;
      }

      coverImageFile = file;

      // Read as base64 for preview and upload
      const reader = new FileReader();
      reader.onload = (e) => {
        coverImageBase64 = e.target.result;

        // Create image to get dimensions
        const img = new Image();
        img.onload = () => {
          // Show preview
          if (coverUploadContent) coverUploadContent.style.display = 'none';
          if (coverPreview) coverPreview.style.display = 'flex';
          if (coverPreviewImg) coverPreviewImg.src = coverImageBase64;
          if (coverFilename) coverFilename.textContent = file.name;
          if (coverDimensions) coverDimensions.textContent = `${img.width}×${img.height} • ${formatFileSize(file.size)}`;

          lucide.createIcons();
        };
        img.src = coverImageBase64;
      };
      reader.readAsDataURL(file);
    }

    // Remove Cover Image
    function removeCoverImage() {
      coverImageFile = null;
      coverImageBase64 = null;

      if (coverUploadContent) coverUploadContent.style.display = 'flex';
      if (coverPreview) coverPreview.style.display = 'none';
      if (coverFileInput) coverFileInput.value = '';

      lucide.createIcons();
    }

    // =============================================
    // BATCH FILE QUEUE MANAGEMENT
    // =============================================

    let fileQueue = []; // Array of {id, file, status, progress, jobId}
    let batchProcessing = false;

    const fileQueueEl = document.getElementById('file-queue');
    const queueListEl = document.getElementById('queue-list');
    const queueCountEl = document.getElementById('queue-count');
    const addMoreFilesBtn = document.getElementById('add-more-files');
    const clearQueueBtn = document.getElementById('clear-queue');
    const batchSummaryEl = document.getElementById('batch-summary');

    // Handle multiple files
    function handleFiles(files) {
      files.forEach(file => {
        // Check if file already in queue
        if (fileQueue.find(q => q.file.name === file.name && q.file.size === file.size)) {
          return; // Skip duplicate
        }

        fileQueue.push({
          id: Date.now() + Math.random().toString(36).substr(2, 9),
          file: file,
          status: 'pending', // pending, processing, completed, failed
          progress: 0,
          jobId: null,
          error: null
        });
      });

      // If only 1 file, use single file mode
      if (fileQueue.length === 1) {
        selectedFile = fileQueue[0].file;
        fileName.textContent = selectedFile.name;
        const sizeInMB = (selectedFile.size / (1024 * 1024)).toFixed(2);
        const extension = selectedFile.name.split('.').pop().toUpperCase();
        fileMeta.textContent = `${sizeInMB} MB • ${extension} Document`;
        uploadZone.style.display = 'none';
        filePreview.classList.add('show');
        fileQueueEl.classList.remove('show');
      } else {
        // Multiple files - show queue
        selectedFile = null;
        filePreview.classList.remove('show');
        uploadZone.style.display = 'none';
        fileQueueEl.classList.add('show');
        renderQueue();
      }

      submitBtn.disabled = false;
      updateSubmitButton();
    }

    // Render file queue
    function renderQueue() {
      queueListEl.innerHTML = fileQueue.map(item => {
        const sizeInMB = (item.file.size / (1024 * 1024)).toFixed(2);
        const ext = item.file.name.split('.').pop().toUpperCase();
        const statusIcon = item.status === 'completed' ? 'check-circle' :
                          item.status === 'failed' ? 'x-circle' :
                          item.status === 'processing' ? 'loader' : 'file-text';

        return `
          <div class="queue-item ${item.status}" data-id="${item.id}">
            <div class="queue-item-icon">
              <i data-lucide="${statusIcon}"></i>
            </div>
            <div class="queue-item-info">
              <div class="queue-item-name">${item.file.name}</div>
              <div class="queue-item-meta">
                <span>${sizeInMB} MB</span>
                <span>•</span>
                <span>${ext}</span>
                ${item.error ? `<span style="color: #EF4444;">• ${item.error}</span>` : ''}
              </div>
            </div>
            <div class="queue-item-progress">
              <div class="queue-item-progress-bar">
                <div class="queue-item-progress-fill" style="width: ${item.progress}%"></div>
              </div>
              <div class="queue-item-progress-text">${item.progress}%</div>
            </div>
            <button class="queue-item-remove" onclick="removeFromQueue('${item.id}')" title="Xóa">
              <i data-lucide="x"></i>
            </button>
          </div>
        `;
      }).join('');

      queueCountEl.textContent = `${fileQueue.length} tệp`;
      lucide.createIcons();

      // Show batch summary if processing started
      if (fileQueue.some(f => f.status !== 'pending')) {
        updateBatchSummary();
      }
    }

    // Update batch summary stats
    function updateBatchSummary() {
      const total = fileQueue.length;
      const completed = fileQueue.filter(f => f.status === 'completed').length;
      const failed = fileQueue.filter(f => f.status === 'failed').length;

      document.getElementById('batch-total').textContent = total;
      document.getElementById('batch-completed').textContent = completed;
      document.getElementById('batch-failed').textContent = failed;

      batchSummaryEl.style.display = 'flex';
    }

    // Remove file from queue
    window.removeFromQueue = function(id) {
      fileQueue = fileQueue.filter(f => f.id !== id);

      if (fileQueue.length === 0) {
        // Reset to initial state
        fileQueueEl.classList.remove('show');
        uploadZone.style.display = 'block';
        submitBtn.disabled = true;
        batchSummaryEl.style.display = 'none';
      } else if (fileQueue.length === 1) {
        // Switch to single file mode
        const remainingFile = fileQueue[0].file;
        fileQueue = [];
        fileQueueEl.classList.remove('show');
        handleFiles([remainingFile]);
      } else {
        renderQueue();
      }
      updateSubmitButton();
    };

    // Clear all files from queue
    clearQueueBtn.addEventListener('click', () => {
      fileQueue = [];
      fileQueueEl.classList.remove('show');
      uploadZone.style.display = 'block';
      submitBtn.disabled = true;
      batchSummaryEl.style.display = 'none';
      fileInput.value = '';
    });

    // Add more files
    addMoreFilesBtn.addEventListener('click', () => {
      fileInput.click();
    });

    // Update submit button text based on queue
    function updateSubmitButton() {
      if (fileQueue.length > 1) {
        submitBtn.innerHTML = `<i data-lucide="sparkles"></i><span>Xử lý ${fileQueue.length} tệp</span>`;
      } else {
        submitBtn.innerHTML = '<i data-lucide="sparkles"></i><span>Bắt đầu xử lý</span>';
      }
      lucide.createIcons();
    }

    // Handle single file for backward compatibility
    function handleFile(file) {
      handleFiles([file]);
    }

    // Remove File (single file mode)
    fileRemove.addEventListener('click', () => {
      selectedFile = null;
      fileQueue = [];
      fileInput.value = '';
      filePreview.classList.remove('show');
      uploadZone.style.display = 'block';
      submitBtn.disabled = true;
    });

    // Options Toggle
    optionsToggle.addEventListener('click', () => {
      optionsToggle.classList.toggle('expanded');
      optionsPanel.classList.toggle('show');
    });

    // Background mode button
    backgroundBtn.addEventListener('click', () => {
      if ('Notification' in window && Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
      addActivity('Chế độ chạy ngầm đã bật', 'success');
      backgroundBtn.innerHTML = '<i data-lucide="check"></i><span>Đã bật thông báo</span>';
      backgroundBtn.style.background = 'var(--accent-light)';
      backgroundBtn.style.color = 'var(--accent-primary)';
      lucide.createIcons();
    });

    // Preview tabs - switch between translated and original
    document.querySelectorAll('.preview-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentPreviewTab = tab.dataset.tab;
        renderPreviewContent();
      });
    });

    // Render preview content based on current tab
    function renderPreviewContent() {
      const content = document.getElementById('preview-content');
      const empty = document.getElementById('preview-empty');

      if (previewData.length === 0) {
        if (empty) empty.style.display = 'block';
        return;
      }

      if (empty) empty.style.display = 'none';

      // Clear existing chunks
      content.querySelectorAll('.preview-chunk').forEach(c => c.remove());

      // Add chunks in reverse order (newest first)
      [...previewData].reverse().forEach(item => {
        const chunk = document.createElement('div');
        chunk.className = 'preview-chunk';
        const text = currentPreviewTab === 'translated' ? item.translated : item.original;
        chunk.innerHTML = `
          <div class="preview-chunk-header">
            <span class="chunk-badge">Chunk ${item.index}</span>
            <span class="chunk-time">${item.time}</span>
          </div>
          <div class="preview-text">${text}</div>
        `;
        content.appendChild(chunk);
      });
    }

    // Format time
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Format number with commas
    function formatNumber(num) {
      return num.toLocaleString();
    }

    // Add activity item
    function addActivity(message, type = 'normal') {
      activityCount++;
      const list = document.getElementById('activity-list');
      const item = document.createElement('div');
      item.className = 'activity-item';
      item.innerHTML = `
        <div class="activity-dot ${type}"></div>
        <div class="activity-content">
          <div class="activity-message">${message}</div>
          <div class="activity-time">${new Date().toLocaleTimeString('vi-VN')}</div>
        </div>
      `;
      list.insertBefore(item, list.firstChild);
      document.getElementById('activity-count').textContent = `${activityCount} sự kiện`;
    }

    // Add preview chunk - stores both original and translated
    function addPreviewChunk(chunkIndex, original, translated) {
      const time = new Date().toLocaleTimeString('vi-VN');
      previewData.push({
        index: chunkIndex,
        original: original,
        translated: translated,
        time: time
      });
      renderPreviewContent();
    }

    // Rotate tips
    function rotateTips() {
      currentTipIndex = (currentTipIndex + 1) % tips.length;
      const tip = tips[currentTipIndex];
      document.getElementById('tips-title').textContent = tip.title;
      document.getElementById('tips-text').textContent = tip.text;
    }

    // Update step indicators
    function updateStep(stepNum) {
      for (let i = 1; i <= 3; i++) {
        const stepEl = document.getElementById(`step-${i}`);
        if (i < stepNum) {
          stepEl.classList.remove('active');
          stepEl.classList.add('completed');
        } else if (i === stepNum) {
          stepEl.classList.add('active');
          stepEl.classList.remove('completed');
        } else {
          stepEl.classList.remove('active', 'completed');
        }
      }
    }

    // =============================================
    // API FUNCTIONS - Real Backend Integration
    // =============================================

    // Helper to convert error to string
    function errorToString(error) {
      if (typeof error === 'string') return error;
      if (error instanceof Error) return error.message;
      if (error && typeof error === 'object') {
        // Handle API error responses
        if (error.detail) return typeof error.detail === 'string' ? error.detail : JSON.stringify(error.detail);
        if (error.message) return error.message;
        if (error.error) return typeof error.error === 'string' ? error.error : JSON.stringify(error.error);
        return JSON.stringify(error);
      }
      return String(error);
    }

    // ============================================================
    // TRANSLATION ENGINE MANAGEMENT
    // ============================================================

    // Fetch available engines from API
    async function fetchAvailableEngines() {
      try {
        const response = await fetch(`${API_BASE}/api/engines`);
        if (response.ok) {
          availableEngines = await response.json();
          updateEngineSelector();
          updateEngineStatus();
        }
      } catch (error) {
        console.error('Failed to fetch engines:', error);
        updateEngineStatus('error', 'Could not load engines');
      }
    }

    // Update engine selector dropdown
    function updateEngineSelector() {
      const select = document.getElementById('translation-engine');
      if (!select || !availableEngines.length) return;

      // Clear existing options except first (auto)
      while (select.options.length > 1) {
        select.remove(1);
      }

      // Add available engines
      availableEngines.forEach(engine => {
        const option = document.createElement('option');
        option.value = engine.id;

        const icon = engine.offline ? '🏠' : '☁️';
        const status = engine.available ? '' : ' (Unavailable)';
        option.textContent = `${icon} ${engine.name}${status}`;
        option.disabled = !engine.available;

        select.appendChild(option);
      });
    }

    // Update engine status indicator
    function updateEngineStatus(status, text) {
      const statusDot = document.querySelector('.status-dot');
      const statusText = document.querySelector('.status-text');

      if (!statusDot || !statusText) return;

      if (status && text) {
        statusDot.className = `status-dot ${status}`;
        statusText.textContent = text;
        return;
      }

      // Auto-detect status based on selected engine
      const engineId = document.getElementById('translation-engine')?.value || 'auto';

      if (engineId === 'auto') {
        const localEngine = availableEngines.find(e => e.id.includes('translategemma') && e.available);
        if (localEngine) {
          statusDot.className = 'status-dot available';
          statusText.textContent = `Will use: ${localEngine.name} (Free)`;
        } else {
          statusDot.className = 'status-dot available';
          statusText.textContent = 'Will use: Cloud API';
        }
      } else {
        const engine = availableEngines.find(e => e.id === engineId);
        if (engine?.available) {
          statusDot.className = 'status-dot available';
          const cost = engine.cost_per_token === 0 ? 'Free' : 'Pay per use';
          statusText.textContent = `Ready (${cost})`;
        } else {
          statusDot.className = 'status-dot unavailable';
          statusText.textContent = 'Not available';
        }
      }
    }

    // Update engine info panel
    function updateEngineInfo() {
      const panel = document.getElementById('engine-stats');
      if (!panel) return;

      const engineId = document.getElementById('translation-engine')?.value || 'auto';
      let engine = availableEngines.find(e => e.id === engineId);

      // For auto, show the engine that will be used
      if (engineId === 'auto') {
        engine = availableEngines.find(e => e.id.includes('translategemma') && e.available)
                || availableEngines.find(e => e.id.includes('cloud') && e.available);
      }

      if (!engine) {
        panel.innerHTML = '<p>No engine information available</p>';
        return;
      }

      panel.innerHTML = `
        <div class="engine-stat">
          <span class="engine-stat-label">Engine</span>
          <span class="engine-stat-value">${engine.name}</span>
        </div>
        <div class="engine-stat">
          <span class="engine-stat-label">Status</span>
          <span class="engine-stat-value">${engine.available ? '✅ Ready' : '❌ Unavailable'}</span>
        </div>
        <div class="engine-stat">
          <span class="engine-stat-label">Cost</span>
          <span class="engine-stat-value ${engine.cost_per_token === 0 ? 'free' : ''}">${engine.cost_per_token === 0 ? 'FREE' : '$0.001/1K tokens'}</span>
        </div>
        <div class="engine-stat">
          <span class="engine-stat-label">Offline</span>
          <span class="engine-stat-value">${engine.offline ? 'Yes ✓' : 'No'}</span>
        </div>
        <div class="engine-stat">
          <span class="engine-stat-label">Languages</span>
          <span class="engine-stat-value">${engine.languages_count || 55}</span>
        </div>
        ${engine.device ? `
        <div class="engine-stat">
          <span class="engine-stat-label">Device</span>
          <span class="engine-stat-value">${engine.device.toUpperCase()}</span>
        </div>
        ` : ''}
      `;
    }

    // Toggle engine info panel
    function toggleEngineInfo() {
      const content = document.getElementById('engine-info-content');
      const chevron = document.querySelector('.engine-info-panel .chevron');

      if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.textContent = '▲';
        updateEngineInfo();
      } else {
        content.style.display = 'none';
        chevron.textContent = '▼';
      }
    }

    // Handle engine selection change
    function onEngineChange() {
      const select = document.getElementById('translation-engine');
      selectedEngine = select?.value || 'auto';

      updateEngineStatus();
      updateEngineInfo();

      // Save preference
      localStorage.setItem('preferred_engine', selectedEngine);
    }

    // Get selected engine for API calls
    function getSelectedEngine() {
      return selectedEngine || 'auto';
    }

    // Initialize engine management
    function initEngineManagement() {
      // Load saved preference
      const saved = localStorage.getItem('preferred_engine');
      if (saved) {
        const select = document.getElementById('translation-engine');
        if (select) {
          select.value = saved;
          selectedEngine = saved;
        }
      }

      // Add change listener
      const select = document.getElementById('translation-engine');
      if (select) {
        select.addEventListener('change', onEngineChange);
      }

      // Fetch available engines
      fetchAvailableEngines();
    }

    // Upload file to server
    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch(`${API_BASE}/api/upload`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Upload failed');
        }

        const data = await response.json();
        return data.server_path || data.path || data.file_path;
      } catch (error) {
        console.error('Upload error:', error);
        throw error;
      }
    }

    // Create translation job using V2 API (with layout preservation)
    async function createJob(filePath, sourceLang, targetLang, outputFormats, docxTemplate, pdfTemplate) {
      // Get appropriate API key based on selected model
      const selectedModel = document.getElementById('model-select').value || 'gpt-4o-mini';
      const isClaudeModel = selectedModel.toLowerCase().includes('claude');
      const settings = getSettings();
      const apiKey = isClaudeModel ? (settings.anthropicApiKey || '') : (settings.apiKey || '');

      // Map profile from UI settings
      const profileSelect = document.getElementById('profile-select');
      const profileMap = {
        'academic': 'academic_paper',
        'business': 'business_report',
        'book': 'novel',
        'technical': 'technical_doc'
      };
      const profileId = profileMap[profileSelect?.value] || 'novel';

      // Determine provider from model selection
      const provider = isClaudeModel ? 'anthropic' : 'openai';

      // Build FormData for V2 API (supports layout preservation)
      const formData = new FormData();
      formData.append('file', selectedFile);
      // Keep 'auto' to let backend detect language (important for Korean, Chinese, etc.)
      formData.append('source_language', sourceLang === 'auto' ? 'auto' : sourceLang);
      formData.append('target_language', targetLang);
      formData.append('profile_id', profileId);
      formData.append('output_formats', (outputFormats || ['docx', 'pdf', 'txt', 'md']).join(','));
      formData.append('use_vision', useVision ? 'true' : 'false');
      formData.append('docx_template', docxTemplate || 'auto');
      formData.append('pdf_template', pdfTemplate || 'auto');
      formData.append('provider', provider);  // Send provider selection
      formData.append('model', selectedModel);  // Send model name
      if (apiKey) {
        formData.append('api_key', apiKey);
      }

      console.log(`Creating job with provider=${provider}, model=${selectedModel}`);

      try {
        // Use V2 API for proper layout preservation
        const response = await fetch(`${API_BASE}/api/v2/publish`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorToString(errorData));
        }

        const data = await response.json();
        console.log('V2 API response:', data);
        return data.job_id;
      } catch (error) {
        console.error('Create job error:', error);
        throw error;
      }
    }

    // Ensure batch processor is running (V1 API only - V2 auto-processes)
    async function ensureProcessorRunning() {
      // V2 API processes jobs immediately, no batch processor needed
      console.log('Using V2 API - auto-processing enabled');
    }

    // Poll job progress using V2 API
    async function pollProgress(jobId) {
      try {
        // V2 API: GET /api/v2/jobs/{job_id}
        const response = await fetch(`${API_BASE}/api/v2/jobs/${jobId}`);

        if (!response.ok) {
          if (response.status === 404) {
            return { status: 'not_found' };
          }
          throw new Error('Failed to get progress');
        }

        const data = await response.json();
        // Map V2 response to expected format
        return {
          status: data.status,
          progress: data.progress || 0,
          progress_percent: data.progress || 0,
          current_stage: data.current_stage || '',
          chunks_completed: data.chunks_completed || 0,
          chunks_total: data.chunks_total || 1,
          tokens_used: data.usage?.total_tokens || 0,
          cost_usd: data.usage?.total_cost_usd || 0,
          output_paths: data.output_paths || {}
        };
      } catch (error) {
        console.error('Progress poll error:', error);
        return null;
      }
    }

    // Get preview content (V2 API doesn't have preview - returns null)
    async function fetchPreview(jobId, limit = 10) {
      // V2 API doesn't support preview - return null gracefully
      console.log('Preview not available in V2 API');
      return null;
    }

    // Download file in specific format
    async function downloadFile(jobId, format) {
      const card = document.querySelector(`.format-card[data-format="${format}"]`);
      if (card) {
        card.classList.add('downloading');
        // Add spinner using appendChild instead of innerHTML to preserve existing content
        const spinner = document.createElement('div');
        spinner.className = 'format-card-spinner';
        card.appendChild(spinner);
      }

      try {
        // V2 API: GET /api/v2/jobs/{job_id}/download/{format_type}
        const response = await fetch(`${API_BASE}/api/v2/jobs/${jobId}/download/${format}`);

        if (!response.ok) {
          throw new Error(`Download failed: ${response.statusText}`);
        }

        // Get filename from Content-Disposition header or generate one
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `${selectedFile.name.replace(/\.[^/.]+$/, '')}_translated.${format}`;
        if (contentDisposition) {
          const match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
          if (match && match[1]) {
            filename = match[1].replace(/['"]/g, '');
          }
        }

        // Download the file
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Mark as downloaded
        downloadedFormats.add(format);
        if (card) {
          card.classList.remove('downloading');
          card.classList.add('downloaded');
          const spinnerEl = card.querySelector('.format-card-spinner');
          if (spinnerEl) spinnerEl.remove();
        }
        lucide.createIcons();

        addActivity(`Đã tải xuống bản ${format.toUpperCase()}`, 'success');
        return true;
      } catch (error) {
        console.error(`Download ${format} error:`, error);
        if (card) {
          card.classList.remove('downloading');
          const spinnerEl = card.querySelector('.format-card-spinner');
          if (spinnerEl) spinnerEl.remove();
        }
        addActivity(`Lỗi tải ${format.toUpperCase()}: ${error.message}`, 'warning');
        return false;
      }
    }

    // Global download function for onclick
    window.downloadFormat = async function(format) {
      if (!currentJobId) {
        addActivity('Không tìm thấy job ID', 'warning');
        return;
      }
      await downloadFile(currentJobId, format);
    };

    // =============================================
    // BATCH PROCESSING
    // =============================================

    async function processBatchFiles() {
      if (batchProcessing) return;
      batchProcessing = true;

      // Setup UI for batch processing
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span><span>Đang xử lý hàng loạt...</span>';
      progressSection.classList.add('show');
      downloadSection.classList.remove('show');

      // Start timer
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('stat-time').textContent = formatTime(elapsed);
      }, 1000);

      const sourceLang = document.getElementById('source-lang').value;
      const targetLang = document.getElementById('target-lang').value;
      const docxTemplate = document.getElementById('docx-template').value;
      const pdfTemplate = document.getElementById('pdf-template').value;

      addActivity(`Bắt đầu xử lý ${fileQueue.length} tệp`, 'success');
      document.getElementById('progress-subtitle').textContent = `Đang xử lý ${fileQueue.length} tệp...`;

      // Process files sequentially
      for (let i = 0; i < fileQueue.length; i++) {
        const item = fileQueue[i];

        // Skip if already completed or failed
        if (item.status === 'completed' || item.status === 'failed') continue;

        // Update status to processing
        item.status = 'processing';
        item.progress = 0;
        renderQueue();

        addActivity(`[${i+1}/${fileQueue.length}] Đang xử lý: ${item.file.name}`);
        document.getElementById('progress-subtitle').textContent = `[${i+1}/${fileQueue.length}] ${item.file.name}`;

        try {
          // Upload file
          const filePath = await uploadFile(item.file);
          item.progress = 20;
          renderQueue();

          // Create job
          const jobId = await createJob(filePath, sourceLang, targetLang, ['docx', 'pdf', 'txt', 'md'], docxTemplate, pdfTemplate);
          item.jobId = jobId;
          item.progress = 30;
          renderQueue();

          // Ensure processor is running
          await ensureProcessorRunning();

          // Poll until complete
          await pollBatchItemProgress(item, i, fileQueue.length);

          // Success
          item.status = 'completed';
          item.progress = 100;
          addActivity(`Hoàn thành: ${item.file.name}`, 'success');

          // Add to history
          addToHistory({
            id: item.jobId,
            name: item.file.name,
            status: 'completed'
          });

        } catch (error) {
          item.status = 'failed';
          item.error = error.message || 'Lỗi không xác định';
          addActivity(`Thất bại: ${item.file.name} - ${item.error}`, 'error');

          // Add to history
          addToHistory({
            id: item.jobId || 'unknown',
            name: item.file.name,
            status: 'failed'
          });
        }

        renderQueue();
        updateBatchSummary();

        // Update overall progress
        const overallProgress = ((i + 1) / fileQueue.length) * 100;
        document.getElementById('progress-fill').style.width = `${overallProgress}%`;
        document.getElementById('progress-percentage').textContent = `${Math.floor(overallProgress)}%`;
      }

      // Batch complete
      batchProcessing = false;
      clearInterval(timerInterval);

      const completed = fileQueue.filter(f => f.status === 'completed').length;
      const failed = fileQueue.filter(f => f.status === 'failed').length;

      addActivity(`Hoàn thành hàng loạt: ${completed} thành công, ${failed} thất bại`, completed > 0 ? 'success' : 'error');
      document.getElementById('progress-subtitle').textContent = `Hoàn thành ${completed}/${fileQueue.length} tệp`;

      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i data-lucide="download"></i><span>Tải xuống tất cả</span>';
      lucide.createIcons();

      // Show download section with batch downloads
      showBatchDownloads();
    }

    // Poll progress for a single batch item
    async function pollBatchItemProgress(item, index, total) {
      return new Promise((resolve, reject) => {
        const pollInterval = setInterval(async () => {
          try {
            const progress = await pollProgress(item.jobId);

            if (!progress) return;

            const percent = typeof progress.progress_percent === 'number' ? progress.progress_percent :
                           (typeof progress.progress === 'number' ? progress.progress : 0);

            item.progress = 30 + (percent * 0.7); // Scale 30-100
            renderQueue();

            // Update stats
            const chunksCompleted = progress.chunks_completed || progress.completed_chunks || 0;
            const totalChunks = progress.total_chunks || progress.chunks_total || 0;
            if (totalChunks > 0) {
              document.getElementById('stat-chunks').textContent = `${chunksCompleted}/${totalChunks}`;
            }

            // Check if complete
            const status = progress.status || '';
            if (status === 'complete' || status === 'completed' || percent >= 100) {
              clearInterval(pollInterval);
              resolve();
            } else if (status === 'failed' || status === 'error') {
              clearInterval(pollInterval);
              reject(new Error(progress.error || 'Job failed'));
            }
          } catch (error) {
            clearInterval(pollInterval);
            reject(error);
          }
        }, 2000);

        // Timeout after 30 minutes per file
        setTimeout(() => {
          clearInterval(pollInterval);
          reject(new Error('Timeout'));
        }, 30 * 60 * 1000);
      });
    }

    // Show batch download options
    function showBatchDownloads() {
      downloadSection.classList.add('show');

      // Update download section for batch mode
      const completedItems = fileQueue.filter(f => f.status === 'completed');

      if (completedItems.length === 0) {
        document.getElementById('download-title').textContent = 'Không có tệp hoàn thành';
        return;
      }

      document.getElementById('download-title').textContent = `Tải xuống ${completedItems.length} tệp`;

      // Add batch download functionality
      document.querySelectorAll('.format-card').forEach(card => {
        card.onclick = async () => {
          const format = card.dataset.format;
          card.classList.add('downloading');

          for (const item of completedItems) {
            try {
              await downloadFile(item.jobId, format);
            } catch (e) {
              console.error(`Failed to download ${item.file.name}:`, e);
            }
          }

          card.classList.remove('downloading');
          card.classList.add('downloaded');
        };
      });
    }

    // =============================================
    // MAIN SUBMIT HANDLER
    // =============================================

    submitBtn.addEventListener('click', async () => {
      // If processing is complete, scroll to download section
      if (isProcessingComplete) {
        downloadSection.scrollIntoView({ behavior: 'smooth' });
        return;
      }

      // Check if batch mode (multiple files in queue)
      if (fileQueue.length > 1) {
        await processBatchFiles();
        return;
      }

      if (!selectedFile && fileQueue.length === 0) return;

      // Use file from queue if selectedFile not set
      if (!selectedFile && fileQueue.length === 1) {
        selectedFile = fileQueue[0].file;
      }

      // Reset state for new processing
      previewData = [];
      isProcessingComplete = false;
      downloadedFormats.clear();
      currentJobId = null;
      serverFilePath = null;

      // Reset download cards
      document.querySelectorAll('.format-card').forEach(card => {
        card.classList.remove('downloaded', 'downloading');
        const spinner = card.querySelector('.format-card-spinner');
        if (spinner) spinner.remove();
      });

      // Setup UI for processing
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span><span>Đang tải lên...</span>';
      progressSection.classList.add('show');
      downloadSection.classList.remove('show');

      // Update file info in progress header
      document.getElementById('progress-subtitle').textContent = `${selectedFile.name} • Đang tải lên...`;

      // Start timer
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('stat-time').textContent = formatTime(elapsed);
      }, 1000);

      // Rotate tips every 10 seconds
      const tipsInterval = setInterval(rotateTips, 10000);

      // Add initial activity
      addActivity('Bắt đầu tải lên tài liệu', 'success');

      try {
        // Step 1: Upload file
        updateStep(1);
        serverFilePath = await uploadFile(selectedFile);
        addActivity('Tải lên thành công', 'success');
        document.getElementById('progress-fill').style.width = '10%';
        document.getElementById('progress-percentage').textContent = '10%';

        // Step 2: Create translation job
        submitBtn.innerHTML = '<span class="spinner"></span><span>Đang xử lý...</span>';
        document.getElementById('progress-subtitle').textContent = `${selectedFile.name} • Đang khởi tạo...`;

        const sourceLang = document.getElementById('source-lang').value;
        const targetLang = document.getElementById('target-lang').value;
        const docxTemplate = document.getElementById('docx-template').value;
        const pdfTemplate = document.getElementById('pdf-template').value;

        currentJobId = await createJob(serverFilePath, sourceLang, targetLang, ['docx', 'pdf', 'txt', 'md'], docxTemplate, pdfTemplate);
        addActivity(`Khởi tạo job: ${currentJobId.substring(0, 8)}...`, 'success');

        // Ensure batch processor is running
        await ensureProcessorRunning();

        // Step 3: Poll progress
        updateStep(2);
        addActivity('Bắt đầu dịch thuật...');

        let lastProgress = 0;
        let lastChunkCount = 0;

        progressPollInterval = setInterval(async () => {
          const progress = await pollProgress(currentJobId);

          if (!progress) return;

          // Debug log to console
          console.log('Progress response:', progress);

          // Update progress bar
          const percent = typeof progress.progress_percent === 'number' ? progress.progress_percent :
                         (typeof progress.progress === 'number' ? progress.progress : 0);
          document.getElementById('progress-fill').style.width = `${percent}%`;
          document.getElementById('progress-percentage').textContent = `${Math.floor(percent)}%`;

          // Update ETA - handle various response formats
          if (progress.estimated_remaining_seconds && typeof progress.estimated_remaining_seconds === 'number') {
            const mins = Math.ceil(progress.estimated_remaining_seconds / 60);
            document.getElementById('progress-eta').textContent = `Còn khoảng ${mins} phút`;
          } else if (progress.eta && typeof progress.eta === 'string') {
            document.getElementById('progress-eta').textContent = progress.eta;
          } else if (progress.message && typeof progress.message === 'string') {
            document.getElementById('progress-eta').textContent = progress.message;
          }

          // Update stats
          const chunksCompleted = typeof progress.chunks_completed === 'number' ? progress.chunks_completed :
                                  (typeof progress.completed_chunks === 'number' ? progress.completed_chunks : undefined);
          const totalChunks = typeof progress.total_chunks === 'number' ? progress.total_chunks :
                             (typeof progress.chunks_total === 'number' ? progress.chunks_total : undefined);

          if (chunksCompleted !== undefined && totalChunks !== undefined) {
            document.getElementById('stat-chunks').textContent = `${chunksCompleted}/${totalChunks}`;

            // Add activity for new chunks
            if (chunksCompleted > lastChunkCount) {
              const newChunks = chunksCompleted - lastChunkCount;
              addActivity(`Hoàn thành ${newChunks} chunks`, 'success');
              lastChunkCount = chunksCompleted;
            }
          }

          if (progress.tokens_used !== undefined) {
            document.getElementById('stat-tokens').textContent = formatNumber(progress.tokens_used);
            document.getElementById('stat-cost').textContent = `$${(progress.tokens_used * 0.00001).toFixed(4)}`;
          }

          // Update step indicator based on progress
          if (percent < 20) {
            updateStep(1);
          } else if (percent < 90) {
            updateStep(2);
          } else {
            updateStep(3);
          }

          // Update subtitle with page count if available
          if (progress.pages) {
            document.getElementById('progress-subtitle').textContent = `${selectedFile.name} • ${progress.pages} trang`;
          }

          // Fetch preview periodically
          if (percent > lastProgress + 10) {
            const preview = await fetchPreview(currentJobId, 5);
            if (preview) {
              // Handle both API formats: preview.chunks or preview.preview
              const chunks = preview.chunks || preview.preview || [];
              chunks.forEach((chunk, idx) => {
                const chunkIndex = chunk.index || idx + 1;
                if (!previewData.find(p => p.index === chunkIndex)) {
                  // Handle various field names for translated text
                  const translatedText = chunk.translated || chunk.text || '';
                  const originalText = chunk.original || chunk.source || '';
                  addPreviewChunk(chunkIndex, originalText, translatedText);
                }
              });
            }
            lastProgress = percent;
          }

          // Check if completed
          if (progress.status === 'completed' || percent >= 100) {
            clearInterval(progressPollInterval);
            onProcessingComplete(tipsInterval);
          } else if (progress.status === 'failed' || progress.status === 'error') {
            clearInterval(progressPollInterval);
            onProcessingError(errorToString(progress.error) || 'Unknown error', tipsInterval);
          }
        }, 2000); // Poll every 2 seconds

      } catch (error) {
        onProcessingError(errorToString(error), tipsInterval);
      }
    });

    // Processing complete handler
    async function onProcessingComplete(tipsInterval) {
      clearInterval(timerInterval);
      clearInterval(tipsInterval);
      if (progressPollInterval) clearInterval(progressPollInterval);

      isProcessingComplete = true;

      document.getElementById('progress-percentage').textContent = '100%';
      document.getElementById('progress-fill').style.width = '100%';
      document.getElementById('progress-eta').textContent = 'Hoàn thành!';
      document.getElementById('progress-spinner').style.display = 'none';
      document.getElementById('progress-title').textContent = 'Hoàn thành!';

      // Fetch final preview
      try {
        const preview = await fetchPreview(currentJobId, 10);
        console.log('Final preview response:', preview);
        if (preview) {
          const chunks = preview.chunks || preview.preview || [];
          if (chunks.length > 0) {
            chunks.forEach((chunk, idx) => {
              const chunkIndex = chunk.index || idx + 1;
              if (!previewData.find(p => p.index === chunkIndex)) {
                // API may return only 'text' field (translated content)
                const translatedText = chunk.translated || chunk.text || '';
                const originalText = chunk.original || chunk.source || '';
                addPreviewChunk(chunkIndex, originalText, translatedText);
              }
            });
          } else {
            // No chunks in response, show a message
            addPreviewChunk(1, '', 'Nội dung đã được xử lý. Tải xuống để xem kết quả.');
          }
        }
      } catch (e) {
        console.error('Failed to fetch final preview:', e);
      }

      // Update button
      submitBtn.innerHTML = '<i data-lucide="download"></i><span>Xem định dạng tải</span>';
      submitBtn.disabled = false;
      submitBtn.style.background = '#10B981';
      lucide.createIcons();

      // Show download section
      downloadSection.classList.add('show');
      document.getElementById('download-subtitle').textContent = `${selectedFile.name} • Chọn định dạng để tải`;

      addActivity('Tài liệu đã sẵn sàng để tải xuống', 'success');

      // Show notification if in background mode
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('AI Publisher Pro', {
          body: 'Tài liệu của bạn đã được xử lý xong!',
          icon: '/favicon.ico'
        });
      }

      // Scroll to download section
      setTimeout(() => {
        downloadSection.scrollIntoView({ behavior: 'smooth' });
      }, 500);
    }

    // Processing error handler
    function onProcessingError(errorMessage, tipsInterval) {
      clearInterval(timerInterval);
      clearInterval(tipsInterval);
      if (progressPollInterval) clearInterval(progressPollInterval);

      document.getElementById('progress-title').textContent = 'Lỗi xử lý';
      document.getElementById('progress-spinner').style.display = 'none';
      document.getElementById('progress-eta').textContent = errorMessage;

      submitBtn.innerHTML = '<i data-lucide="refresh-cw"></i><span>Thử lại</span>';
      submitBtn.disabled = false;
      submitBtn.style.background = '#EF4444';
      lucide.createIcons();

      addActivity(`Lỗi: ${errorMessage}`, 'warning');

      // Reset for retry
      isProcessingComplete = false;
    }

    // Simulate progress animation
    async function simulateProgress(from, to, duration) {
      const steps = 20;
      const stepDuration = duration / steps;
      const increment = (to - from) / steps;

      for (let i = 0; i <= steps; i++) {
        const progress = from + (increment * i);
        document.getElementById('progress-fill').style.width = progress + '%';
        document.getElementById('progress-percentage').textContent = Math.floor(progress) + '%';
        await new Promise(resolve => setTimeout(resolve, stepDuration));
      }
    }

    // =============================================
    // THEME SYSTEM
    // =============================================

    const STORAGE_KEY_THEME = 'ai-publisher-theme';
    const STORAGE_KEY_HISTORY = 'ai-publisher-history';
    const STORAGE_KEY_SETTINGS = 'ai-publisher-settings';

    // Get system theme preference
    function getSystemTheme() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    // Apply theme to document
    function applyTheme(theme) {
      if (theme === 'system') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
      updateThemeToggleUI(theme);
    }

    // Update theme toggle UI
    function updateThemeToggleUI(theme) {
      document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
      });
    }

    // Initialize theme
    function initTheme() {
      const savedTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'system';
      applyTheme(savedTheme);

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        const currentTheme = localStorage.getItem(STORAGE_KEY_THEME);
        if (currentTheme === 'system' || !currentTheme) {
          applyTheme('system');
        }
      });
    }

    // Theme toggle click handler
    document.getElementById('theme-toggle').addEventListener('click', (e) => {
      const btn = e.target.closest('.theme-option');
      if (!btn) return;

      const theme = btn.dataset.theme;
      localStorage.setItem(STORAGE_KEY_THEME, theme);
      applyTheme(theme);
    });

    // =============================================
    // HISTORY PANEL
    // =============================================

    const historyBtn = document.getElementById('history-btn');
    const historyPanel = document.getElementById('history-panel');
    const historyOverlay = document.getElementById('history-overlay');
    const historyClose = document.getElementById('history-close');
    const historyList = document.getElementById('history-list');
    const historyEmpty = document.getElementById('history-empty');

    // Open history panel
    function openHistoryPanel() {
      historyPanel.classList.add('show');
      historyOverlay.classList.add('show');
      renderHistory();
    }

    // Close history panel
    function closeHistoryPanel() {
      historyPanel.classList.remove('show');
      historyOverlay.classList.remove('show');
    }

    // Get history from localStorage
    function getHistory() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
      } catch {
        return [];
      }
    }

    // Save history to localStorage
    function saveHistory(history) {
      localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history.slice(0, 20))); // Keep last 20
    }

    // Add job to history
    function addToHistory(job) {
      const history = getHistory();
      const newItem = {
        id: job.id || currentJobId,
        name: job.name || selectedFile?.name || 'Document',
        status: job.status || 'completed',
        date: new Date().toISOString(),
        sourceLang: job.sourceLang || document.getElementById('source-lang').value,
        targetLang: job.targetLang || document.getElementById('target-lang').value
      };
      history.unshift(newItem);
      saveHistory(history);
    }

    // Render history list
    function renderHistory() {
      const history = getHistory();

      if (history.length === 0) {
        historyEmpty.style.display = 'block';
        historyList.innerHTML = '';
        return;
      }

      historyEmpty.style.display = 'none';

      historyList.innerHTML = history.map(item => {
        const date = new Date(item.date);
        const timeAgo = getTimeAgo(date);
        const statusClass = item.status === 'completed' ? 'success' :
                          item.status === 'failed' ? 'failed' : 'pending';
        const statusIcon = item.status === 'completed' ? 'check-circle' :
                          item.status === 'failed' ? 'x-circle' : 'clock';
        const statusText = item.status === 'completed' ? 'Hoàn thành' :
                          item.status === 'failed' ? 'Thất bại' : 'Đang xử lý';

        return `
          <div class="history-item" data-job-id="${item.id}">
            <div class="history-item-icon ${statusClass}">
              <i data-lucide="${statusIcon}"></i>
            </div>
            <div class="history-item-content">
              <div class="history-item-name">${item.name}</div>
              <div class="history-item-meta">
                <span>${item.sourceLang?.toUpperCase() || 'EN'} → ${item.targetLang?.toUpperCase() || 'VI'}</span>
                <span>•</span>
                <span>${timeAgo}</span>
              </div>
            </div>
            <span class="history-item-status ${statusClass}">${statusText}</span>
          </div>
        `;
      }).join('');

      // Add clear button
      historyList.innerHTML += `
        <button class="history-clear" onclick="clearHistory()">
          <i data-lucide="trash-2"></i>
          <span>Xóa lịch sử</span>
        </button>
      `;

      lucide.createIcons();
    }

    // Get time ago string
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Vừa xong';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes} phút trước`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours} giờ trước`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days} ngày trước`;
      return date.toLocaleDateString('vi-VN');
    }

    // Clear history
    window.clearHistory = function() {
      localStorage.removeItem(STORAGE_KEY_HISTORY);
      renderHistory();
    };

    // History panel event listeners
    historyBtn.addEventListener('click', openHistoryPanel);
    historyClose.addEventListener('click', closeHistoryPanel);
    historyOverlay.addEventListener('click', closeHistoryPanel);

    // =============================================
    // SETTINGS PANEL
    // =============================================

    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const settingsOverlay = document.getElementById('settings-overlay');
    const settingsClose = document.getElementById('settings-close');
    const notificationToggle = document.getElementById('notification-toggle');
    const autosaveToggle = document.getElementById('autosave-toggle');
    const apiKeyInput = document.getElementById('api-key-input');
    const saveApiKeyBtn = document.getElementById('save-api-key');
    const anthropicApiKeyInput = document.getElementById('anthropic-api-key-input');
    const saveAnthropicApiKeyBtn = document.getElementById('save-anthropic-api-key');

    // Open settings panel
    function openSettingsPanel() {
      settingsPanel.classList.add('show');
      settingsOverlay.classList.add('show');
      loadSettings();
    }

    // Close settings panel
    function closeSettingsPanel() {
      settingsPanel.classList.remove('show');
      settingsOverlay.classList.remove('show');
    }

    // Get settings from localStorage
    function getSettings() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS)) || {
          notifications: false,
          autosave: true,
          apiKey: '',
          anthropicApiKey: ''
        };
      } catch {
        return { notifications: false, autosave: true, apiKey: '', anthropicApiKey: '' };
      }
    }

    // Save settings to localStorage
    function saveSettings(settings) {
      localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
    }

    // Load settings into UI
    function loadSettings() {
      const settings = getSettings();
      notificationToggle.classList.toggle('active', settings.notifications);
      autosaveToggle.classList.toggle('active', settings.autosave);
      if (settings.apiKey) {
        apiKeyInput.value = settings.apiKey;
      }
      if (settings.anthropicApiKey && anthropicApiKeyInput) {
        anthropicApiKeyInput.value = settings.anthropicApiKey;
      }
    }

    // Toggle switch click handler
    function setupToggle(toggleEl, key) {
      toggleEl.addEventListener('click', () => {
        toggleEl.classList.toggle('active');
        const settings = getSettings();
        settings[key] = toggleEl.classList.contains('active');
        saveSettings(settings);

        // Request notification permission if enabled
        if (key === 'notifications' && settings.notifications) {
          if ('Notification' in window && Notification.permission !== 'granted') {
            Notification.requestPermission();
          }
        }
      });
    }

    setupToggle(notificationToggle, 'notifications');
    setupToggle(autosaveToggle, 'autosave');

    // Save OpenAI API key
    saveApiKeyBtn.addEventListener('click', () => {
      const settings = getSettings();
      settings.apiKey = apiKeyInput.value;
      saveSettings(settings);
      saveApiKeyBtn.textContent = 'Đã lưu!';
      saveApiKeyBtn.style.background = '#10B981';
      setTimeout(() => {
        saveApiKeyBtn.textContent = 'Lưu';
        saveApiKeyBtn.style.background = '';
      }, 2000);
    });

    // Save Anthropic API key
    if (saveAnthropicApiKeyBtn) {
      saveAnthropicApiKeyBtn.addEventListener('click', () => {
        const settings = getSettings();
        settings.anthropicApiKey = anthropicApiKeyInput.value;
        saveSettings(settings);
        saveAnthropicApiKeyBtn.textContent = 'Đã lưu!';
        saveAnthropicApiKeyBtn.style.background = '#10B981';
        setTimeout(() => {
          saveAnthropicApiKeyBtn.textContent = 'Lưu';
          saveAnthropicApiKeyBtn.style.background = '';
        }, 2000);
      });
    }

    // Settings panel event listeners
    settingsBtn.addEventListener('click', openSettingsPanel);
    settingsClose.addEventListener('click', closeSettingsPanel);
    settingsOverlay.addEventListener('click', closeSettingsPanel);

    // Close panels with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeHistoryPanel();
        closeSettingsPanel();
      }
    });

    // =============================================
    // UPDATE PROCESSING COMPLETE TO SAVE HISTORY
    // =============================================

    // Wrap original onProcessingComplete to add history
    const originalOnProcessingComplete = onProcessingComplete;
    onProcessingComplete = async function(tipsInterval) {
      // Add to history
      addToHistory({
        id: currentJobId,
        name: selectedFile?.name,
        status: 'completed'
      });
      // Call original function
      await originalOnProcessingComplete(tipsInterval);
    };

    // Wrap original onProcessingError to add history
    const originalOnProcessingError = onProcessingError;
    onProcessingError = function(errorMessage, tipsInterval) {
      // Add to history
      addToHistory({
        id: currentJobId,
        name: selectedFile?.name,
        status: 'failed'
      });
      // Call original function
      originalOnProcessingError(errorMessage, tipsInterval);
    };

    // =============================================
    // INITIALIZE
    // =============================================

    initTheme();
    initEngineManagement();
  </script>
</body>
</html>
